name: Deploy izuba backend App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: â¬ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      # === BACKEND BUILD (on GitHub runner) ===
      - name: ğŸ“¦ Install backend dependencies
        working-directory: ./backend
        run: npm install

      - name: ğŸ§¬ Prisma generate
        working-directory: ./backend
        run: npx prisma generate

      - name: ğŸ›  Build backend (more heap)
        working-directory: ./backend
        env:
          NODE_OPTIONS: --max-old-space-size=2048
        run: npm run build

      # Prepare a clean deploy folder (NOW INCLUDES src/Templates)
      - name: ğŸ“¦ Prepare backend artifact
        run: |
          rm -rf backend_deploy
          mkdir -p backend_deploy

          # dist
          cp -R backend/dist backend_deploy/dist

          # package files
          cp backend/package.json backend_deploy/package.json
          if [ -f backend/package-lock.json ]; then cp backend/package-lock.json backend_deploy/package-lock.json; fi

          # prisma folder
          if [ -d backend/prisma ]; then cp -R backend/prisma backend_deploy/prisma; fi

          # env (only if you really want to ship it from repo)
          if [ -f backend/.env ]; then cp backend/.env backend_deploy/.env; fi

          # âœ… templates (your code expects /src/Templates)
          mkdir -p backend_deploy/src
          if [ -d backend/src/Templates ]; then cp -R backend/src/Templates backend_deploy/src/Templates; fi

          # optional: show what will be deployed
          echo "=== DEPLOY TREE ==="
          ls -la backend_deploy
          ls -la backend_deploy/src || true
          ls -la backend_deploy/src/Templates || true

      # === BACKEND DEPLOYMENT ===
      - name: ğŸ“‚ Upload backend to VPS via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 162.0.224.102
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          fingerprint: ${{ secrets.SSH_FINGERPRINT }}
          source: "backend_deploy/**"
          target: "/var/www/izuba"
          strip_components: 1
          overwrite: true
